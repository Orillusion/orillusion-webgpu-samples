import"./modulepreload-polyfill-3cfb730f.js";import{b as x}from"./basic.instanced.vert-cbfe75ff.js";import{p as B}from"./position.frag-8baafb48.js";import{a as P,v as g}from"./cube-91a5abf9.js";import{b}from"./math-7b9ebb83.js";import"./mat4-5036aab8.js";async function E(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const o=await navigator.gpu.requestAdapter();if(!o)throw new Error("No Adapter Found");const s=await o.requestDevice(),n=e.getContext("webgpu"),t=navigator.gpu.getPreferredCanvasFormat(),r=window.devicePixelRatio||1;e.width=e.clientWidth*r,e.height=e.clientHeight*r;const u={width:e.width,height:e.height};return n.configure({device:s,format:t,alphaMode:"opaque"}),{device:s,context:n,format:t,size:u}}async function y(e,o,s){const n=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:x}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:B}),entryPoint:"main",targets:[{format:o}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),t=e.createTexture({size:s,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),r=t.createView(),u=e.createBuffer({label:"GPUBuffer store vertex",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(u,0,g);const d=e.createBuffer({label:"GPUBuffer store n*4x4 matrix",size:4*4*4*f,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),p=e.createBindGroup({label:"Uniform Group with matrix",layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:d}}]});return{pipeline:n,vertexBuffer:u,mvpBuffer:d,group:p,depthTexture:t,depthView:r}}function T(e,o,s){const n=e.createCommandEncoder(),t=n.beginRenderPass(o);t.executeBundles(s),t.end(),e.queue.submit([n.finish()])}const f=1e4;async function U(){const e=document.querySelector("canvas");if(!e)throw new Error("No Canvas");const{device:o,context:s,format:n,size:t}=await E(e),r=await y(o,n,t);let u=t.width/t.height;const d=[],p=new Float32Array(f*4*4);for(let a=0;a<f;a++){const i={x:Math.random()*40-20,y:Math.random()*40-20,z:-50-Math.random()*50},c={x:0,y:0,z:0},l={x:1,y:1,z:1};d.push({position:i,rotation:c,scale:l})}let h;{const a=o.createRenderBundleEncoder({colorFormats:[n],depthStencilFormat:"depth24plus"});a.setPipeline(r.pipeline),console.time("recordBundles");for(let i=0;i<f;i++)a.setVertexBuffer(0,r.vertexBuffer),a.setBindGroup(0,r.group),a.draw(P,1,0,i);console.timeEnd("recordBundles"),h=[a.finish()]}function m(){for(let i=0;i<d.length-1;i++){const c=d[i],l=Date.now()/1e3;c.rotation.x=Math.sin(l+i),c.rotation.y=Math.cos(l+i);const w=b(u,c.position,c.rotation,c.scale);p.set(w,i*4*4)}o.queue.writeBuffer(r.mvpBuffer,0,p);const a={colorAttachments:[{view:s.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:r.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}};T(o,a,h),requestAnimationFrame(m)}m(),window.addEventListener("resize",()=>{t.width=e.width=e.clientWidth*devicePixelRatio,t.height=e.height=e.clientHeight*devicePixelRatio,r.depthTexture.destroy(),r.depthTexture=o.createTexture({size:t,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),r.depthView=r.depthTexture.createView(),u=t.width/t.height})}U();
