import"./modulepreload-polyfill-3cfb730f.js";import{b as U}from"./basic.vert-ae845a6f.js";import{i as v}from"./imageTexture.frag-294b8beb.js";import{v as P,a as B}from"./cube-91a5abf9.js";import{b as S}from"./math-7b9ebb83.js";import"./mat4-5036aab8.js";async function C(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const r=await navigator.gpu.requestAdapter();if(!r)throw new Error("No Adapter Found");const o=await r.requestDevice(),s=e.getContext("webgpu"),n=navigator.gpu.getPreferredCanvasFormat(),i=window.devicePixelRatio||1;e.width=e.clientWidth*i,e.height=e.clientHeight*i;const t={width:e.width,height:e.height};return s.configure({device:o,format:n,alphaMode:"opaque"}),{device:o,context:s,format:n,size:t}}async function R(e,r,o){const s=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:U}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:v}),entryPoint:"main",targets:[{format:r}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),n=e.createTexture({size:o,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),i=n.createView(),t=e.createBuffer({label:"GPUBuffer store vertex",size:P.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(t,0,P);const c=e.createBuffer({label:"GPUBuffer store 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=e.createBindGroup({label:"Uniform Group with Matrix",layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}}]});return{pipeline:s,vertexBuffer:t,mvpBuffer:c,uniformGroup:f,depthTexture:n,depthView:i}}function M(e,r,o,s){const n=e.createCommandEncoder(),i={colorAttachments:[{view:r.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:o.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},t=n.beginRenderPass(i);t.setPipeline(o.pipeline),t.setBindGroup(0,o.uniformGroup),t.setBindGroup(1,s),t.setVertexBuffer(0,o.vertexBuffer),t.draw(B),t.end(),e.queue.submit([n.finish()])}async function A(){const e=document.querySelector("canvas#webgpu"),r=document.querySelector("canvas#canvas");if(!e||!r)throw new Error("No Canvas");const{device:o,context:s,format:n,size:i}=await C(e),t=await R(o,n,i),c=[r.width,r.height],f=o.createTexture({size:c,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),E=o.createSampler({magFilter:"linear",minFilter:"linear"}),b=o.createBindGroup({label:"Texture Group with Texture/Sampler",layout:t.pipeline.getBindGroupLayout(1),entries:[{binding:0,resource:E},{binding:1,resource:f.createView()}]});let m=i.width/i.height;const y={x:0,y:0,z:-5},G={x:1,y:1,z:1},p={x:0,y:0,z:0};function x(){const a=Date.now()/1e3;p.x=Math.sin(a),p.y=Math.cos(a);const u=S(m,y,p,G);o.queue.writeBuffer(t.mvpBuffer,0,u.buffer),o.queue.copyExternalImageToTexture({source:r},{texture:f},c),M(o,s,t,b),requestAnimationFrame(x)}requestAnimationFrame(x),window.addEventListener("resize",()=>{i.width=e.width=e.clientWidth*devicePixelRatio,i.height=e.height=e.clientHeight*devicePixelRatio,t.depthTexture.destroy(),t.depthTexture=o.createTexture({size:i,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),t.depthView=t.depthTexture.createView(),m=i.width/i.height});{const a=r.getContext("2d");if(!a)throw new Error("No support 2d");a.fillStyle="#fff",a.lineWidth=5,a.lineCap="round",a.lineJoin="round",a.fillRect(0,0,r.width,r.height);let u=!1,h=0,g=0,l=0;r.addEventListener("pointerdown",d=>{u=!0,h=d.offsetX,g=d.offsetY}),r.addEventListener("pointermove",d=>{if(!u)return;const w=d.offsetX,T=d.offsetY;l=l>360?0:l+1,a.strokeStyle=`hsl(${l}, 90%, 50%)`,a.beginPath(),a.moveTo(h,g),a.lineTo(w,T),a.stroke(),h=w,g=T}),r.addEventListener("pointerup",()=>u=!1),r.addEventListener("pointerout",()=>u=!1)}}A();
